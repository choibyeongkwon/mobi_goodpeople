<!doctype html>
<html lang="ko">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>아이템 합계 입력판</title>
<style>
  :root { --w-name: 180px; --w-item: 180px; --pad: 10px; }
  * { box-sizing: border-box; font-family: system-ui, sans-serif; }
  body { margin: 0; padding: 16px; background:#fafafa; }
  .app { max-width: 820px; margin: 0 auto; }
  .toolbar { display:flex; gap:8px; margin-bottom: 10px; align-items:center; }
  input[type=text], input[type=number] { width: 100%; padding:8px; border:1px solid #ccc; border-radius:8px; }
  button { padding:8px 12px; border:1px solid #444; background:#fff; border-radius:8px; cursor:pointer; }
  button.primary { background:#222; color:#fff; }
  .grid {
    display: grid;
    grid-template-columns: var(--w-name) var(--w-item) var(--w-item) 110px;
    gap: 8px;
    align-items: center;
  }
  .hdr { font-weight: 700; text-align:center; padding:8px; border:1px solid #000; background:#fff; border-radius:8px; }
  .cell { padding:0; }
  .row { display: contents; }
  .sumlabel { text-align:center; }
  .muted { color:#666; font-size:12px; }
  .danger { color:#c00; }
  .right { text-align:right; }
</style>
</head>
<body>
<div class="app">
  <div class="toolbar">
    <button id="btn-add" class="primary">+ 사용자 추가</button>
    <span class="muted">숫자는 0 이상 정수/실수 입력 가능. 입력 후 자동 저장(0.6초 지연).</span>
  </div>

  <div id="status" class="muted">불러오는 중…</div>

  <div class="grid" role="table" aria-label="아이템 입력표">
    <!-- 헤더 -->
    <div class="hdr">이름</div>
    <div class="hdr">밧줄</div>
    <div class="hdr">두꺼운 옷감</div>
    <div class="hdr">작업</div>

    <!-- 데이터 행들 -->
    <div id="rows"></div>

    <!-- 합계 행 -->
    <div class="hdr sumlabel">합계</div>
    <div class="hdr right" id="sum-item1">0</div>
    <div class="hdr right" id="sum-item2">0</div>
    <div class="hdr"></div>
  </div>

  <p class="muted" id="last-updated"></p>
</div>

<script>
/** ====== 설정 ====== **/
const GAS_WEB_APP_URL = 'https://script.google.com/macros/s/AKfycbyltw0u3kCEyQqubYAW-vUVt5fCRWAjxDu6NYpK5ZoT9kQPZAsgz1C-SnS75nAUkBIu/exec'; // …/exec

/** ====== 유틸 ====== **/
const $ = s => document.querySelector(s);
const el = (tag, attrs={}, ...kids) => {
  const n = document.createElement(tag);
  Object.entries(attrs).forEach(([k,v]) => {
    if (k === 'class') n.className = v;
    else if (k === 'dataset') Object.entries(v).forEach(([dk,dv])=> n.dataset[dk]=dv);
    else if (k.startsWith('on') && typeof v === 'function') n.addEventListener(k.slice(2), v);
    else n.setAttribute(k, v);
  });
  kids.forEach(k => n.append(k));
  return n;
};
const toNum = v => {
  const n = Number(String(v).trim().replace(/,/g,''));
  return Number.isFinite(n) ? n : 0;
};
const fmt = n => {
  const x = Number(n ?? 0);
  return Number.isFinite(x) ? (Math.round(x*1000)/1000).toLocaleString() : '0';
};

let state = { rows: [] };

/** ====== 렌더링 ====== **/
function render() {
  const rowsHost = $('#rows');
  rowsHost.innerHTML = '';

  let sum1 = 0, sum2 = 0;
  state.rows.forEach(row => {
    sum1 += toNum(row.item1);
    sum2 += toNum(row.item2);

    const nameInput = el('input', { type:'text', value: row.name || '', placeholder:'이름', oninput: debounce(() => saveRow(row.id, {
      name: nameInput.value, item1: toNum(item1Input.value), item2: toNum(item2Input.value)
    }), 600) });

    const item1Input = el('input', { type:'number', step:'any', inputmode:'decimal',
      value: row.item1 ?? 0, class:'right',
      oninput: debounce(() => saveRow(row.id, {
        name: nameInput.value, item1: toNum(item1Input.value), item2: toNum(item2Input.value)
      }), 600)
    });

    const item2Input = el('input', { type:'number', step:'any', inputmode:'decimal',
      value: row.item2 ?? 0, class:'right',
      oninput: debounce(() => saveRow(row.id, {
        name: nameInput.value, item1: toNum(item1Input.value), item2: toNum(item2Input.value)
      }), 600)
    });

    const delBtn = el('button', { onclick: () => delRow(row.id) }, '삭제');

    rowsHost.append(
      el('div', { class:'row' },
        el('div', { class:'cell' }, nameInput),
        el('div', { class:'cell' }, item1Input),
        el('div', { class:'cell' }, item2Input),
        el('div', { class:'cell' }, delBtn),
      )
    );
  });

  $('#sum-item1').textContent = fmt(sum1);
  $('#sum-item2').textContent = fmt(sum2);

  const latest = state.rows.map(r => r.updated_at ? new Date(r.updated_at) : null)
                           .filter(Boolean)
                           .sort((a,b)=>b-a)[0];
  $('#last-updated').textContent = latest ? `최종 갱신: ${latest.toLocaleString()}` : '';
}

function debounce(fn, ms) {
  let t; return (...args) => { clearTimeout(t); t = setTimeout(()=>fn(...args), ms); };
}

/** ====== API ====== **/
async function apiGet() {
  setStatus('불러오는 중…');
  const r = await fetch(GAS_WEB_APP_URL);
  const j = await r.json();
  if (!j.ok) throw new Error(j.error || 'GET 실패');
  state.rows = j.rows || [];
  setStatus('');
  render();
}

async function apiPost(payload) {
  const r = await fetch(GAS_WEB_APP_URL, {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify(payload),
  });
  const j = await r.json();
  if (!j.ok) throw new Error(j.error || 'POST 실패');
  return j;
}

/** ====== 동작 ====== **/
async function addUser() {
  const name = prompt('새 사용자 이름을 입력하세요');
  if (!name) return;
  try {
    setStatus('추가 중…');
    const j = await apiPost({ action: 'insert', name, item1: 0, item2: 0 });
    state.rows.push(j.row);
    render();
    setStatus('추가 완료');
  } catch (e) {
    setStatus(`오류: ${e.message}`, true);
  }
}

async function saveRow(id, { name, item1, item2 }) {
  try {
    // 낙관적 UI: 로컬 업데이트 후 합계 재계산
    const i = state.rows.findIndex(r => r.id === id);
    if (i >= 0) {
      state.rows[i] = { ...state.rows[i], name, item1, item2, updated_at: new Date().toISOString() };
      render();
    }
    await apiPost({ action: 'update', id, name, item1, item2 });
    setStatus('저장됨');
  } catch (e) {
    setStatus(`저장 실패: ${e.message}`, true);
    // 실제 데이터와 불일치 시 재동기화
    await apiGet();
  }
}

async function delRow(id) {
  if (!confirm('이 사용자를 삭제할까요?')) return;
  try {
    setStatus('삭제 중…');
    await apiPost({ action: 'delete', id });
    state.rows = state.rows.filter(r => r.id !== id);
    render();
    setStatus('삭제됨');
  } catch (e) {
    setStatus(`삭제 실패: ${e.message}`, true);
  }
}

function setStatus(msg, isErr=false) {
  const s = $('#status');
  s.textContent = msg || '';
  s.classList.toggle('danger', !!isErr);
}

/** ====== 이벤트 & 초기화 ====== **/
$('#btn-add').addEventListener('click', addUser);
apiGet(); // 초기 로드
</script>
</body>
</html>
